name: follow_facebook

on:
  workflow_dispatch:
    inputs:
      key:
        description: 'Key Tool'
        required: true
        type: string
      link:
        description: 'Link Facebook'
        required: true
        type: string

jobs:
  buff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: curl, json, fileinfo

      - name: Run Script
        id: run_script
        continue-on-error: true
        run: php buff.php
        env:
          INPUT_KEY: ${{ github.event.inputs.key }}
          INPUT_LINK: ${{ github.event.inputs.link }}

      - name: Prepare Result for Webhook
        id: prepare
        if: always()
        run: |
          if [ -f result.txt ]; then
            # Đọc nội dung file và mã hóa URL
            CONTENT=$(cat result.txt)
            # Mã hóa bằng Python để an toàn
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$CONTENT'''))")
            echo "RESULT=$ENCODED" >> $GITHUB_ENV
            echo "HAS_RESULT=true" >> $GITHUB_ENV
          else
            echo "RESULT=Khong%20tim%20thay%20file%20result.txt" >> $GITHUB_ENV
            echo "HAS_RESULT=false" >> $GITHUB_ENV
          fi

      - name: Send to Webhook (GET)
        if: always()
        run: |
          curl -v "https://vphuc.online/api/webhook.php?result=${{ env.RESULT }}"

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: logs
          path: |
            result.txt
            debug.log
            *.log
          retention-days: 7
